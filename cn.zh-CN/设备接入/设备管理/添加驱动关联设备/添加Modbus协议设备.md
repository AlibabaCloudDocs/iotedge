添加Modbus协议设备 
=================================

物联网边缘计算支持通过关联Modbus驱动，关联Modbus协议的终端设备到边缘一体机。

前提条件 
-------------------------

已完成操作：[分配驱动到主机](/cn.zh-CN/设备接入/设备管理/添加驱动关联设备/分配驱动到主机.md)。

操作步骤 
-------------------------

1. 登录[边缘计算控制台](https://iotedge.console.aliyun.com)。

   

2. 在左侧导航栏选择 **节点管理** \> **终端设备管理** 。

   

3. 在 **终端设备管理** 页面，选择 ***您的目标主机名称*** \> **通用设备** \> ***您的目标驱动名称*** 。

   

4. 在 **设备列表** 区域下，单击 **添加设备** 。

   

5. 在弹出的 **添加设备** 对话框中，单击 **所属产品** 下的 **打开产品管理页** 。

   

6. 系统跳转到[物联网平台控制台](http://iot.console.aliyun.com/)，创建 **节点类型** 为 **网关子设备** 、 **接入网关协议** 为 **Modbus** 的产品，其余参数可自定义设置或保持默认值。详细操作，请参见[创建产品](/cn.zh-CN/设备接入/创建产品.md)。

   ![新版-添加modbus协议设备](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3213713061/p172870.png)
   

7. 创建产品完成后，为Modbus产品添加物模型。详细操作，请参见[单个添加物模型](/cn.zh-CN/设备管理/物模型/添加物模型/单个添加物模型.md)。

   在配置物模型属性的过程中，单击 **新增扩展描述** ，设置如下 **扩展描述** 参数，将属性映射到寄存器中。官方Modbus驱动会将所有的属性聚合为Modbus数据请求，驱动收到Modbus数据之后再转换为物模型数据。

   ![modbus新增扩展描述 ](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/9128853951/p48543.png)

   参数说明如下所示，详细的参数解释，请参见[单个添加物模型](/cn.zh-CN/设备管理/物模型/添加物模型/单个添加物模型.md)中"扩展描述"的说明。
   

   |     名称     |                                                                                                描述                                                                                                |
   |------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | 操作类型       | 指操作Modbus的功能码。此处选择 **保持寄存器（读写，读取使用0x03，写入使用0x06）** 。                                                                                                                                             |
   | 寄存器地址      | 填写十六进制，以0x开头。根据您自己设备的属性地址设置寄存器地址。例如，要调试温度属性，您设备的温度属性地址为1，则寄存器地址可设置为0x1。                                                                                                                          |
   | 原始数据类型     | 从下拉列表中选择原始数据类型，例如设备采集的温度值数据类型为浮点型。                                                                                                                                                               |
   | 取值范围       | 取值范围指的是原始数据经过缩放因子处理之后的取值范围，超出取值范围的数据会被丢弃。                                                                                                                                                        |
   | 交换寄存器内高低字节 | 是否把寄存器内16位数据的前后8个bits互换。此处设置为互换true。                                                                                                                                                             |
   | 交换寄存器顺序    | 是否把原始数据32位数据的bits互换。此处设置为不互换false。                                                                                                                                                               |
   | 缩放因子       | 指缩放系数，如采集的值为100， 但真实的值为10，因此需要缩小10倍，故缩放因子填写0.1即可。若放大10倍（即真实的值为1000），则缩放因子为10。                                                                                                                    |
   | 数据上报方式     | 有两种数据上报方式： * **按时上报** ：选择按时上报后，根据步骤10中为子设备设置的数据采集间隔，采集数据并上报。   * **变更上报** ：采集后的值发生变化后才会上报。    |

   

8. 返回[边缘计算控制台](https://iotedge.console.aliyun.com)的 **节点管理** \> **终端设备管理** 页面。在 **添加设备** 对话框中，为刚刚创建的产品添加设备。

   设置 **设备名称** 和 **备注名称** ，然后单击 **确定** 。
   

9. 在 **设备列表** 区域框下，单击 **驱动配置** ，添加边缘一体机与设备之间通信的通道。

   1. 在 **驱动配置** 面板中单击 **添加通道** 。

      ![新版-添加modbus通道](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1271906261/p172884.png)
      
   
   2. 根据界面提示设置参数，然后单击 **确定** 。

      

      |    参数    |                                    描述                                    |
      |----------|--------------------------------------------------------------------------|
      | 通道名称     | 设置通道名称，需在边缘一体机维度具有唯一性。支持中文汉字、英文字母、数字和下划线（_），长度不超过1\~30个字符，1个中文汉字算2个字符。   |
      | 传输模式     | 支持 **RTU** 、 **TCP** 和 **LoRa LAN** 三种。                                  |
      | 当传输模式为 **RTU** 时，需设置以下参数：                                                          ||
      | 串口       | 设置串口，如`/dev/ttyUSB0`、`/dev/ttyUSB1`。支持英文字母、数字、正斜杠（/）和下划线（_），长度限制1\~64字符。 |
      | 波特率      | 表示每秒传送的符号个数，从下拉列表中选择。                                                    |
      | 数据位      | 表示一组数据实际包含的数据位数，从下拉列表中选择。                                                |
      | 校验位      | 从下拉列表中选择奇偶校验或者无校验。                                                       |
      | 停止位      | 用于表示单个包的最后一位，从下拉列表中选择。                                                   |
      | 当传输模式为 **TCP** 时，需设置以下参数：                                                          ||
      | IP地址     | Modbus设备IP地址，输入点分十进制格式的地址。                                               |
      | 端口号      | Modbus设备端口号，输入1\~65535范围的整数。                                             |
      | 当传输模式为 **LoRa LAN** 时，需设置以下参数：                                                     ||
      | DevAddr  | 设备地址。请填写8位十六进制数值，例如66be\*\*\*\*。                                         |
      | AppSKey  | 应用会话密钥。请填写32位十六进制数值，例如623bd505f042090b5af660954509\*\*\*\*。              |
      | NwkSKey  | 网络会话密钥。请填写32位十六进制数值，例如e1336a94a03aa3beae55b737acda\*\*\*\*。              |
      | Class    | 通信节点的特定类。当前仅支持C特定类，即随时接收设备上报的数据。                                         |
      | 上行 FPort | 上行应用端口，取值范围为1\~223。                                                      |
      | 下行 FPort | 下行应用端口，取值范围为1\~223。                                                      |

      
   

   

10. 添加Modbus设备到边缘一体机后，单击设备名称对应 **操作** 列中的 **设备配置** ，通过关联通道，关联设备与Modbus驱动。

    ![新版-modbus设备配置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/1271906261/p172890.png)
    

    |   参数   |                                                                                                                                       描述                                                                                                                                       |
    |--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    | 关联通道   | 选择步骤9中已创建的通道。                                                                                                                                                                                                                                                                  |
    | 从站号    | 从站号是Modbus设备标识信息，在同一个通道中是唯一的。                                                                                                                                                                                                                                                  |
    | 数据采集间隔 | Modbus协议是半双工协议，由边缘一体机主动请求数据，因此需要指定对数据点的采集间隔时间。单位为毫秒。 **说明** 单个属性点的采集耗时时间大概为60毫秒（ms），则采集间隔的计算方式为： 采集耗时时间(60ms)×该通道的所有属性点个数  例如，当前Modbus总线通道上有10个设备，且每个设备有10个属性点，即采集间隔时间应大于等于6000ms（60ms×10×10=6000ms），这样才能保证每个属性点能正常上报。 |

    

11. 在左侧导航栏选择 **节点管理** \> **主机管理** ，找到刚刚分配了设备的主机名称，单击对应 **操作** 列中的 **主机部署** ，部署终端设备到边缘一体机。更多部署相关信息，请参见[主机部署和管理](/cn.zh-CN/主机管理/云端管理/主机部署和管理.md)。

    



