# 设备数据存入本地MySQL数据库

本文以使用官方示例驱动的LightSensor设备为例，描述将设备的数据存储到本地MySQL数据库的方法。

-   本示例仅适用于Link IoT Edge专业版，请您确保已完成边缘实例的创建。具体操作，请参见[专业版环境搭建](/cn.zh-CN/用户指南/环境搭建/专业版环境搭建/基于Ubuntu 16.04搭建环境.md)。
-   创建光照度传感器产品以及该产品下的LightSensor设备，并将设备分配至边缘实例。具体操作，请参见[示例驱动](/cn.zh-CN/用户指南/设备接入/示例驱动.md)。

在生产中常需要结合传感器的历史数据和行业的算法模型，在边缘端进行分析和判断现场状态。实现此操作首先需要把设备上报的数据存储到本地数据库。

边缘函数计算提供本地数据库存储助手，根据`ProductKey_DeviceName`格式，将设备上报数据分为不同的表，并存储到本地MySQL数据库，供函数计算中的其他函数（算法逻辑）查询。同时，因为边缘设备的存储空间受限，本地数据库还提供数据库单表存储上限配置（默认为1万条记录）和数据写满回滚机制。

## 一、创建MySQL容器镜像应用

MySQL容器镜像应用，将作为MySQL数据库服务（server），供函数（client）访问并在其下创建MySQL数据库。

1.  登录[边缘计算控制台](https://iot.console.aliyun.com/le/instance/list)。

2.  在左侧导航栏单击**应用管理**。

3.  创建容器镜像类型的边缘应用，具体操作，请参见[容器镜像应用](/cn.zh-CN/用户指南/边缘应用/新增自研应用/容器镜像应用.md)。

    部分参数说明如下3个表格所示，其余参数保持默认值或无需配置。

    |参数|描述|
    |--|--|
    |应用名称|设置您应用的名称，例如publicMySql。|
    |应用类型|选择容器镜像。|
    |仓库类型|选择公共仓库。|
    |镜像地址|设置镜像地址为mysql:latest。|
    |应用版本|设置应用的版本，必须是该应用唯一的版本号，即一个应用不可以设置两个相同的版本号。|
    |环境变量|单击**新增环境变量**，添加如下方“环境变量配置”表格所示的一条环境变量。|

    |名称|值|
    |--|--|
    |MYSQL\_ROOT\_PASSWORD|Mysql数据库的root账户密码，例如设置为123abc。|

    |参数|描述|
    |--|--|
    |是否使用宿主机host模式|选择否。|
    |网络端口映射|设置您应用的网络端口映射。     -   宿主机端口：设置为3306。
    -   容器内端口：设置为3306。
    -   类型：选择TCP。 |
    |是否启动特权模式|选择是。|
    |卷映射|设置您的卷映射。     -   源路径：设置为/var/mysql/data。
    -   目的路径：设置为/var/lib/mysql。
    -   读写权限：选择读写。 |

4.  单击**确认**，完成MySQL容器镜像应用的创建。


## 二、分配MySQL容器镜像应用到边缘实例

1.  左侧导航栏单击**边缘实例**。

2.  在本文“前提条件”中完成的边缘实例右侧，单击**查看**。

3.  在实例详情页面**边缘应用**页签，单击**分配应用**。

4.  将已创建的MySQL容器镜像应用publicMySql分配到边缘实例中，单击**关闭**。

5.  在实例详情页面，单击右上角**部署**后在弹出对话框中单击**确定**，将子设备、函数计算等资源下发到边缘端。

    您可以通过单击**部署详情**来查看部署进度及结果。


## 三、创建本地数据库存储函数

1.  下载本地数据库存储函数[saveMysqlDB-code.zip](https://link-iot-edge-packet.oss-cn-shanghai.aliyuncs.com/fc-demo/saveMysqlDB-code.zip)。

2.  登录阿里云[函数计算控制台](https://fc.console.aliyun.com/)。

    如尚未开通该服务，请阅读并勾选**我已阅读并同意**内容，单击**立即开通**，开通服务。

3.  （可选）左侧导航栏单击**服务-函数**，在**新建函数**后的下拉框中选择**新建服务**，根据界面提示配置参数后，单击**创建**创建一个服务。

    其中，**服务名称**必须填写，此处设置为EdgeFC，其余参数可根据您的需求设置，也可以不设置。

    **说明：** 若已操作过其他应用场景示例或小程序示例，即已创建EdgeFC服务，则无需重复创建。

4.  创建服务成功后，在服务-函数页面单击**新建函数**，并使用**事件函数**方式创建函数。

5.  设置本地数据库存储函数的基础管理配置参数。

    |参数|描述|
    |--|--|
    |所在服务|选择已创建的EdgeFC服务。|
    |函数名称|设置为saveMysqlDB。|
    |运行环境|设置函数的运行环境，此示例中选择python3。|
    |函数入口|使用默认值`index.handler`。|
    |函数执行内存|设置为512 MB。|
    |超时时间|设置为10秒。|
    |实例并发度|保持默认值。|

    其余参数的值请根据您的实际需求设置，也可以不设置。详情请参见[函数计算]()。

    确认函数信息后，单击**完成**。

6.  创建函数完成后，系统自动跳转到函数详情页面。请在**代码执行**页签下选择**代码包上传**，单击**选择文件**，上传步骤1中下载的[saveMysqlDB-code.zip](https://link-iot-edge-packet.oss-cn-shanghai.aliyuncs.com/fc-demo/saveMysqlDB-code.zip)代码包，然后单击**保存**。

    代码包上传成功后，您可在**在线编辑**框中查看源码。

    ![saveMysqlDB](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6078879851/p69978.png)

7.  （可选）配置数据库参数。

    saveMysqlDB是一个设备数据存储到本地MySQL数据库的参考示例，您可以按需调整和更改示例。目前预留的可调整参数有：

    -   table\_max\_entries：数据库单表最大记录条数，默认为1万条。
    -   table\_clean\_count：数据库记录到达上限，设置从时间最久远的数据开始删除的条数，默认为4000条。

## 四、分配本地数据库存储函数到边缘实例

1.  使用已创建的saveMysqlDB函数，创建函数计算类型的边缘应用。具体操作，请参见[函数计算应用](/cn.zh-CN/用户指南/边缘应用/新增自研应用/函数计算应用.md)。

    应用信息参数说明如下：

    |参数|描述|
    |--|--|
    |应用名称|设置您应用的名称，例如appsaveMysqlDB。|
    |应用类型|选择函数计算。|
    |地域|选择您创建的服务所在的地域。|
    |服务|选择EdgeFC服务。|
    |函数|选择saveSqliteDB函数。|
    |授权|选择AliyunIOTAccessingFCRole。|
    |应用版本|设置应用的版本，必须是该应用唯一的版本号，即一个应用不可以设置两个相同的版本号。|

    函数配置说明如下：

    |参数|描述|
    |--|--|
    |启用默认配置|选择否。|
    |运行模式|运行模式有两种。此处选择**持续运行**模式。程序部署后会立即执行。|
    |超时限制（秒）|函数收到事件后的最长处理时间，此处使用默认值5秒。如超过该时间函数仍未返回结果，该函数计算程序将会被强制重启。|
    |定时运行|使用默认配置：关闭。|
    |环境变量|单击**新增环境变量**，添加如下方“环境变量配置”表格所示的环境变量。|

    |名称|值|
    |--|--|
    |DB\_NAME|MySQL的数据库名称，请根据MySQL数据库命名规则，自定义设置，例如设置为mysql\_db。|
    |MYSQL\_IP|MySQL服务地址，需通过MySQL容器镜像应用名称来访问。本示例中MySQL容器镜像应用名称为publicMySql。|

    其余参数无需配置。

2.  左侧导航栏单击**边缘实例**。

3.  在本文“前提条件”中完成的边缘实例右侧，单击**查看**。

4.  在实例详情页面**边缘应用**页签，单击**分配应用**。

5.  将已创建的本地数据库存储函数appsaveMysqlDB分配到边缘实例中，单击**关闭**。


## 五、配置消息路由

添加消息路由的详细步骤及各个参数的解释，请参见[设置消息路由](/cn.zh-CN/用户指南/消息路由/设置消息路由.md)。

1.  在实例详情页面，选择**消息路由**。

2.  单击**分配路由**，添加LightSensor设备到函数计算的消息路由。

    按照界面提示，设置如下参数，参数设置完成后单击**确定**。

    |参数|描述|
    |--|--|
    |路由名称|设置一个消息路由名称。|
    |消息来源|此处选择**设备**，选择**光照度传感器** \> **LightSensor**。|
    |消息主题过滤|此处选择**全部**。|
    |消息目标|此处选择**边缘应用**和**appsaveMysqlDB**函数。|


## 六、重新部署边缘实例

1.  在实例详情页面，单击右上角**部署**后在弹出对话框中单击**确定**，将子设备、函数计算等资源下发到边缘端。

    您可以通过单击**部署详情**来查看部署进度及结果。

2.  登录您的网关，执行tail -f /linkedge/run/logger/fc-base/appsaveMysqlDB/log.INFO命令，可以查看该应用的日志，来观察其实际运行情况。

3.  在本地MySQL数据库（本示例中名为mysql\_db的数据库）中执行select \* from YourProductKey\_YourDeviceName;命令，可以查询到通过appsaveMysqlDB应用存储到MySQL数据库的LightSensor设备数据。

    **说明：** 将命令中的YourProductKey\_YourDeviceName替换为您实际设备的设备证书信息，例如本示例中LightSensor设备的ProductKey为a1\*\*\*\*\*xPAf，DeviceName为LightSensor，那么实际执行的命令为select \* from a1\*\*\*\*\*xPAf\_LightSensor。

    ![数据存储](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6078879851/p70000.png)


