# 本地数据库存储助手 {#task_711092 .task}

本文以使用官方示例驱动的LightSensor设备为例，描述将设备的数据存储到本地数据库的方法。

-   本示例仅适用于Link IoT Edge专业版，请您确保已根据[专业版环境搭建](cn.zh-CN/用户指南/环境搭建/专业版环境搭建/基于Ubuntu 16.04搭建环境.md#)内容完成边缘实例的创建。
-   根据[示例驱动](cn.zh-CN/用户指南/设备接入/示例驱动.md#)内容创建光照度传感器产品以及该产品下的LightSensor设备，并将设备分配至边缘实例。

在生产中常需要结合传感器的历史数据和行业的算法模型，在边缘端进行分析和判断现场状态。实现此操作首先需要把设备上报的数据存储到本地数据库。

边缘函数计算提供本地数据库存储助手，根据`ProductKey_DeviceName`格式，将设备上报数据分为不同的表，并存储到本地SQLite数据库，供函数计算中的其他函数（算法逻辑）查询。同时，因为边缘设备的存储空间受限，本地数据库存储助手还提供数据库单表存储上限配置（默认为1万条记录）和数据写满回滚机制。

1.   创建本地数据库存储函数。 
    1.   下载本地数据库存储函数。 [saveSqliteDB-code.zip](http://link-iot-edge-packet.oss-cn-shanghai.aliyuncs.com/fc-demo/saveSqliteDB-code.zip) 
    2.   登录阿里云[函数计算控制台](https://www.aliyun.com/product/fc)。 如尚未开通该服务，请阅读并勾选**我已阅读并同意**内容，单击**立即开通**，开通服务。
    3.   单击**服务列表**后的“`+`”图标，根据界面提示配置参数后，单击**确定**创建一个服务。 其中，**服务名称**必须填写，此处设置为EdgeFC，其余参数可根据您的需求设置，也可以不设置。

        **说明：** 若已操作过其他应用场景示例或小程序示例，即已创建EdgeFC服务，则无需重复创建。

    4.   创建服务成功后，在服务概览页面单击**函数列表**后的“`+`”图标，创建函数。 
    5.   选择函数模板，此处选择**空白函数**模板。 
    6.   在**触发器配置**中，选择**不创建触发器**，单击**下一步**。 
    7.   设置本地数据库存储函数的基础管理配置参数。 

        |参数|描述|
        |--|--|
        |所在服务|选择已创建的EdgeFC服务。|
        |函数名称|设置为saveSqliteDB。|
        |运行环境|设置函数的运行环境，此示例中选择python3。|
        |代码配置|选择**代码包上传**，上传已下载的[saveSqliteDB-code.zip](http://link-iot-edge-packet.oss-cn-shanghai.aliyuncs.com/fc-demo/saveSqliteDB-code.zip)代码包。|

        其余参数的值请根据您的需求，参见[函数计算](https://help.aliyun.com/product/50980.html?spm=a2c4g.11186623.2.8.7e6b1617Ezzl6L)设置，也可以不设置。

    8.   单击**下一步**，进入模板授权管理页面。此处无需设置，单击**下一步**。 
    9.   确认函数信息后，单击**创建**。 创建函数完成后，单击函数名称，可在**代码执行**页签下查看源码。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/570271/156153665349525_zh-CN.png)

    10.  （可选）配置数据库参数。 saveSqliteDB是一个设备数据存储到本地SQLite数据库的参考示例，您可以按需调整和更改示例。目前预留的可调整参数有：
        -    db\_file\_path：SQLite文件路径，默认为/linkedge/run/fc-runtime-data/。
        -    db\_file\_name：SQLite文件名径，默认为device-data-sqlite3.db。
        -    table\_max\_entries：数据库单表最大记录条数，默认为10,000条。
        -    table\_retain\_count：数据库记录到达上限，清理数据库时需要保留的最近记录数，默认为6,000条。
2.   分配函数到边缘实例。 
    1.   登录[物联网平台控制台](http://iot.console.aliyun.com/)。 
    2.   左侧导航栏选择**边缘计算** \> **边缘实例**。 
    3.   在[前提条件](#)中完成的边缘实例右侧，单击**查看**。 
    4.   在实例详情页面，选择**函数计算**，单击**分配函数**。 
    5.   根据界面提示设置参数，将已创建的本地数据库存储函数saveSqliteDB分配到边缘实例中。 函数信息配置说明如下：

        |参数|描述|
        |--|--|
        |地域|选择您创建的服务所在的地域。|
        |服务|选择EdgeFC服务。|
        |函数|选择saveSqliteDB函数。|
        |授权|选择AliyunIOTAccessingFCRole。|

        函数配置说明如下：

        |参数|描述|
        |--|--|
        |运行模式|运行模式有两种。此处选择持续运行模式。程序部署后会立即执行。|
        |内存限制|函数运行可使用的内存资源上限，单位为MB。此处设置为512 MB。当函数使用内存超出该限制时，该函数计算程序会被强制重启。|
        |超时限制|函数收到事件后的最长处理时间，此处使用默认值5秒。如超过该时间函数仍未返回结果，该函数计算程序将会被强制重启。|
        |定时运行|使用默认配置：关闭。|

        其余参数无需配置。

    6.   单击**确认**，至此您已将本地数据库存储函数分配到边缘实例中。 
3.   添加消息路由。 将设备上报的数据发送给saveSqliteDB函数处理，通过saveSqliteDB函数将设备数据存储到本地数据库。添加消息的详细步骤及各个参数的解释，请参考[设置消息路由](cn.zh-CN/用户指南/消息路由/设置消息路由.md#)。
    1.   单击**添加路由**，添加LightSensor设备到函数计算的消息路由。 
    2.   按照界面提示，设置如下参数，参数设置完成后单击**确定**。 

        |参数|描述|
        |--|--|
        |消息来源|此处选择**设备**，选择**光照度传感器** \> **LightSensor**。|
        |消息主题过滤|此处选择**全部**。|
        |消息目标|此处选择**函数计算**和**EdgeFC/saveSqliteDB**函数。|

4.   部署边缘实例并查看设备的运行结果。 

    1.   在实例详情页面，单击右上角**部署**后在弹出框中单击**确定**，将子设备、函数计算下发到边缘端。 您可以通过**部署进程**查看部署进度及结果。
    2.   实例部署成功后，本地数据库存储函数做为一个后台服务存在，将LightSensor设备上报的数据存储到SQLite数据库中。 可以在您的网关设备上查看/linkedge/run/fc-runtime-data/device-data-sqlite3.db文件内容。也可以登录您的网关，执行`tail -f /linkedge/run/logger/fc-base/saveSqliteDB/log.INFO`命令，查看该函数的日志来观察实际函数运行情况。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/570271/156153665349544_zh-CN.png)

    至此您已经完整地体验了使用边缘函数计算实现本地数据库存储的功能。


