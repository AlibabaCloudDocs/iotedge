# 设备驱动应用示例 {#task_ldv_cpn_j2b .task}

本节为您介绍本地设备连接方法，通过设备驱动可实现设备连接网关。设备连接网关的API，请参见[设备接入开发](../../../../cn.zh-CN/开发指南/边缘开发指南/设备接入开发综合示例.md#)。

以定义光照传感器数据发送至云端为例。

1.  在[物联网控制台](https://iot.console.aliyun.com/)创建名称为光照感应器的高级版产品。具体操作，可参考[创建产品\(高级版\)](../../../../cn.zh-CN/用户指南/产品与设备/创建产品(高级版).md#)。 

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15398/15381181546951_zh-CN.png)

    -   产品**节点类型**选择为**设备**。
    -   产品**设备类型**选择为**光照度传感器**。
    -   产品**数据格式**选择为**Alink JSON**。
2.  参考[单个创建设备](../../../../cn.zh-CN/用户指南/产品与设备/创建设备/单个创建设备.md#)，为光照感应器产品添加设备。 

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15398/15381181546953_zh-CN.png)

3.  添加设备驱动，然后将驱动代码的内容压缩为一个zip包（需确保index.js在顶级目录下）。 

    驱动代码如下：

    ```
    /*
     * Copyright (c) 2018 Alibaba Group Holding Ltd.
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *      http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
    
    
    /*
     * The example demonstrates connecting a simulated light sensor to a LinkEdge
     * gateway using LinkEdge Thing Access Node.js SDK. The sensor will continuously
     * report the measured illuminance. Since the function is long-lived it will run
     * forever when deployed to a LinkEdge gateway.
     */
    
    'use strict';
    
    const {
      RESULT_SUCCESS,
      RESULT_FAILURE,
      ThingAccessClient,
    } = require('linkedge-thing-access-sdk');
    
    // Retrieves configs from the FC_DRIVER_CONFIG variable.
    var driverConfig;
    try {
      driverConfig = JSON.parse(process.env.FC_DRIVER_CONFIG)
    } catch (err) {
      throw new Error('The driver config is not in JSON format!');
    }
    var configs = driverConfig['deviceList'];
    if (!Array.isArray(configs) || configs.length === 0) {
      throw new Error('No device is bound with the driver!');
    }
    
    var args = configs.map((config) => {
      var self = {
        lightSensor: {
          illuminance: 100,
        },
        config,
        callbacks: {
          setProperties: function (properties) {
            console.log('Set properties %s to thing %s-%s', JSON.stringify(properties),
              config.productKey, config.deviceName);
            return {
              code: RESULT_FAILURE,
              message: 'The property is read-only.',
            };
          },
          getProperties: function (keys) {
            console.log('Get properties %s from thing %s-%s', JSON.stringify(keys),
              config.productKey, config.deviceName);
            if (keys.includes('MeasuredIlluminance')) {
              return {
                code: RESULT_SUCCESS,
                message: 'success',
                params: {
                  'MeasuredIlluminance': self.lightSensor.illuminance,
                }
              };
            }
            return {
              code: RESULT_FAILURE,
              message: 'The requested properties does not exist.',
            }
          },
          callService: function (name, args) {
            console.log('Call service %s with %s on thing %s-%s', JSON.stringify(name),
              JSON.stringify(args), config.productKey, config.deviceName);
            return {
              code: RESULT_FAILURE,
              message: 'The requested service does not exist.',
            };
          }
        },
      };
      return self;
    });
    
    // Connects to LinkEdge platform.
    args.forEach((item) => {
      var client = new ThingAccessClient(item.config, item.callbacks);
      client.setup()
        .then(() => {
          return client.registerAndOnline();
        })
        .then(() => {
          // Push events and properties to LinkEdge platform every 2 seconds.
          return new Promise(() => {
            setInterval(() => {
              if (item.lightSensor.illuminance >= 600) {
                item.lightSensor.illuminance = 100;
              } else {
                item.lightSensor.illuminance += 100;
              }
              var properties = {'MeasuredIlluminance': item.lightSensor.illuminance};
              console.log(`Report properties: ${JSON.stringify(properties)}`);
              client.reportProperties(properties);
            }, 2000);
          });
        })
        .catch(err => {
          console.log(err);
          client.cleanup();
        })
        .catch(err => {
          console.log(err);
        });
    });
    
    // This is a handler which never be invoked in the example.
    module.exports.handler = function (event, context, callback) {
      console.log(event);
      console.log(context);
      callback(null);
    };
    ```

4.  在物联网平台控制台，选择**边缘管理** \> **驱动管理**，创建驱动。 

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15398/153811815513066_zh-CN.png)

    |参数|描述|
    |--|--|
    |语言类型|选择驱动的语言类型，可以选择**nodejs8**。|
    |驱动名称|可填写为**LightSensor**。|
    |驱动描述|描述将要创建的驱动。|
    |驱动文件|上传步骤3中压缩成zip包的驱动代码文件。|

5.  在物联网平台控制台，创建一个边缘分组，并配置分组内容。 

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/15398/15381181556955_zh-CN.png)

    1.  在分组详情页面，为该分组配置**网关**、**设备驱动**、**设备**。 
        -   网关：选择[控制台创建网关](cn.zh-CN/用户指南/配置边缘计算节点/控制台创建网关.md#)中创建的网关。
        -   设备驱动：选择步骤4中创建的LightSensor驱动。
        -   设备：选择步骤1中创建的光照传感器产品下的所有设备。
6.  单击分组详情页面右上角**部署分组**，将已分配到分组的资源部署至网关中。 

部署成功后，设备上报的属性和事件将会每隔2秒被同步到云端，您可以在IoT控制台设备运行状态页面查看具体信息。

